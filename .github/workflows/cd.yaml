name: 02 CD Pipeline

on:
  workflow_run:
    workflows: ["01_CI_Pipeline"]
    branches: [master]
    types:
      - completed

jobs:
  provision:
    runs-on: ubuntu-latest
    env:
      DOCKER_USERNAME: rm1100  # Set your Docker username here
      TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }} # Set Terraform API Token as an environment variable

    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v3

      - name: "Custom Terraform Provisioning for test Environment"
        id: terraform_provision
        uses: ./.github/actions/terrform_provision
        with:
            terraform_version: "1.10.0"
            tf_workspace: "test"
            docker_image: "${{ env.DOCKER_USERNAME }}/juice-shop:latest"
            tf_api_token: "${{ env.TF_API_TOKEN }}"


      - name: "Custom Terraform Provisioning for Dev Environment"
        id: terraform_provision
        uses: ./.github/actions/terrform_provision
        with:
            terraform_version: "1.10.0"
            tf_workspace: "dev"
            docker_image: "${{ env.DOCKER_USERNAME }}/juice-shop:latest"
            tf_api_token: "${{ env.TF_API_TOKEN }}"
